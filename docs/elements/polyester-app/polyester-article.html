<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="urijs.html">
<link rel="import" href="polyester-theme.html">
<link rel="import" href="prismjs.html">

<script src="../../scripts/js-yaml-front-client.min.js"></script>
<script src="../../bower_components/marked/lib/marked.js"></script>
<script src="../../bower_components/moment/moment.js"></script>
<script src="../../bower_components/moment/locale/ja.js"></script>
<script src="../../bower_components/xregexp/xregexp-all.js"></script>

<dom-module id="polyester-article">
  <template>
    <style include="polyester-theme prism-theme-polyester">
      :host {
        display: block;
      }
      h1 {
        @apply(--polyester-article-title);
        cursor: pointer;
      }
      .timestamp {
        @apply(--polyester-article-timestamp);
      }
      .tag {
        @apply(--polyester-article-tag);
      }
      #content {
        @apply(--polyester-article-content);
      }
      .highlight {
        @apply(--polyester-article-code);
      }
      img {
        max-width: 90%;
      }
      table {
        display: block;
        width: 100%;
        overflow: auto
      }
      table th {
        font-weight: 600
      }
      table th,.markdown-body table td {
        padding: 6px 13px;
        border: 1px solid #dfe2e5
      }
      table tr {
        background-color: #fff;
        border-top: 1px solid #c6cbd1
      }
      table tr:nth-child(2n) {
        background-color: #f6f8fa
      }
      table img {
        background-color: transparent
      }
    </style>
    <h1 id="title" on-tap="_linkToDetailPage">[[_content.title]]</h1>
    <p class="timestamp">[[_formatTimestamp(_content.date)]]</p>
    <template is="dom-repeat" items="[[_content.tags]]" as="tag">
      <span class="tag">[[tag]]</span>
    </template>
    <div id="content"></div>
    <iron-ajax auto url="[[_toMarkdownUrl(item)]]" handle-as="text" on-response="_onResponse"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'polyester-article',
      properties: {
        item: Object,
        _content: Object,
        _renderer: Object,
        _scripts: Array,
        _scriptFrames: Array
      },
      _formatTimestamp: function (datetime) {
        moment.locale('ja');
        return moment(datetime).format('LLLL');
      },
      _onResponse: function (event) {
        this._content = jsyaml.loadFront(event.detail.response);
        Polymer.dom(this.$.content).innerHTML = marked(this._content.__content, {renderer: this._renderer, baseUrl: '/'});
        var scripts = this.$.content.querySelectorAll('.script');
        for (var i = 0; i < scripts.length; i++) {
          var iframe = document.createElement('iframe');
          iframe.setAttribute('width', '100%');
          iframe.setAttribute('frameborder', '0');
          iframe.setAttribute('scrolling','no');
          Polymer.dom(scripts[i]).appendChild(iframe);
          var iframe_doc = iframe.contentWindow.document;
          iframe_doc.open();
          var head = '<head><style>body {margin:0;overflow: hidden;}</style></head>';
          iframe_doc.write(head + '<body>' + this._scripts[i].innerHTML + '</body>');
          iframe_doc.close();
          this._scriptFrames.push({frame: iframe, lastHeight: 0});
        }
        this.updateStyles();
        this.fire('rendered', event.detail);
      },
      _linkToDetailPage: function() {
        location.href = this.item;
      },
      _toMarkdownUrl: function() {
        var uri = new URI(this.item);
        // from {year}/{month}/{day}/{slug}.html
        var pattern = XRegExp('^ /? (?<year>  [0-9]{4} ) /?        # year  \n\
                                    (?<month> [0-9]{2} ) /?        # month \n\
                                    (?<day>   [0-9]{2} ) /?        # day \n\
                                    (?<slug> .+ )\.html$ # slug', 'x');
        // to :year-:month-:day-:slug.html.markdown
        return XRegExp.replace(uri.path(), pattern, '/${year}-${month}-${day}-${slug}.html.markdown');
      },
      ready: function () {
        this._scripts = [];
        this._scriptFrames = [];
        this._renderer = new marked.Renderer();
        this._renderer.html = function (html) {
          var div = document.createElement('div');
          div.innerHTML = html;
          if (div.querySelectorAll('script').length > 0) {
            this._scripts.push(div.firstChild);
            return '<div class="script" data-script-id="'+(this._scripts.length - 1)+'"></div>';
          } else {
            return html;
          }
        }.bind(this);
        this._renderer.code = function (code, lang) {
          if (!lang || !Prism.languages[lang]) {
            lang = 'clike';
          }
          return '<pre class="highlight"><code class="language-' + lang + '">' + Prism.highlight(code, Prism.languages[lang]) + '</code></pre>';
        }.bind(this);

        var frameSync = setInterval(function() {
          for (var i = 0; i < this._scriptFrames.length; i++) {
            var curHeight = this._scriptFrames[i].frame.contentWindow.document.body.scrollHeight;
            if ( curHeight != this._scriptFrames[i].lastHeight ) {
              this._scriptFrames[i].frame.setAttribute('height', this._scriptFrames[i].frame.contentWindow.document.body.scrollHeight + "px");
              this._scriptFrames[i].lastHeight = curHeight;
              this.fire('iron-resize');
            }
          }
        }.bind(this), 1000);
        setTimeout(function() {
          clearInterval(frameSync);
        }, 1000 * 20);

      }
    });
  </script>
</dom-module>
